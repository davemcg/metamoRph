<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="metamoRph">
<title>Metadata Label Transfer on Real Data • metamoRph</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Metadata Label Transfer on Real Data">
<meta property="og:description" content="metamoRph">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">metamoRph</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/So_many_ways_to_screw_up_PCA_projection.html">So many ways to screw up PCA projection</a>
    <a class="dropdown-item" href="../articles/build_a_brain_region_predictor.html">Build and Apply a Human Brain Region Predictor in 60 seconds or less</a>
    <a class="dropdown-item" href="../articles/real_data_testing.html">Metadata Label Transfer on Real Data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Metadata Label Transfer on Real Data</h1>
            
      
      
      <div class="d-none name"><code>real_data_testing.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Here we take data from the <a href="eyeIntegration.nei.nih.gov">EiaD</a> resource, which has been cut
down to a few dozen cornea, retina, and RPE samples as well as the first
few thousand most variable genes (as calculated by variance).</p>
</div>
<div class="section level2">
<h2 id="load-libraries">Load libraries<a class="anchor" aria-label="anchor" href="#load-libraries"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/genesofeve/projectR/" class="external-link">projectR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davemcg.github.io/metamoRph/">metamoRph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="import-eiad-data">Import EiaD data<a class="anchor" aria-label="anchor" href="#import-eiad-data"></a>
</h2>
<p>An ocular subset of the full resource (full data can be found at
eyeIntegration.nei.nih.gov)</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">feature_by_sample</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'test_data/EiaD__eye_samples_counts.csv.gz'</span>, package <span class="op">=</span> <span class="st">'metamoRph'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="va">feature_by_sample</span><span class="op">$</span><span class="va">Gene</span></span>
<span><span class="va">feature_by_sample</span> <span class="op">&lt;-</span> <span class="va">feature_by_sample</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">feature_by_sample</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">genes</span></span>
<span><span class="va">meta_ref</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'test_data/EiaD__eye_samples_metaRef.csv.gz'</span>, package <span class="op">=</span> <span class="st">'metamoRph'</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">meta_project</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'test_data/EiaD__eye_samples_metaProject.csv.gz'</span>, package <span class="op">=</span> <span class="st">'metamoRph'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="projectr">projectR<a class="anchor" aria-label="anchor" href="#projectr"></a>
</h2>
<p>As projectR does not apply the prcomp row (gene) scaling, the new
data ends up in the center of the PCA plot. Scaling on the new data
alone also results in the variation between the samples being
exaggerated.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_matrix</span> <span class="op">&lt;-</span> <span class="va">feature_by_sample</span><span class="op">[</span>,<span class="va">meta_ref</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">sample_accession</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Pvars</span> <span class="op">&lt;-</span> <span class="fu">matrixStats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowVars.html" class="external-link">rowVars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">ref_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">select</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">Pvars</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">1000</span>,</span>
<span>                                                      <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Pvars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pr_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ref_matrix</span><span class="op">[</span><span class="va">select</span>,<span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                 center <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_mat_for_projection</span> <span class="op">&lt;-</span> <span class="va">feature_by_sample</span><span class="op">[</span><span class="va">select</span>,</span>
<span>                                            <span class="va">meta_project</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">sample_accession</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">pr_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/projectR/man/projectR-methods.html" class="external-link">projectR</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    loadings <span class="op">=</span> <span class="va">pr_run</span>,</span>
<span>                    dataNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1000 row names matched between data and loadings"</span></span>
<span><span class="co">#&gt; [1] "Updated dimension of data: 1000 12"</span></span>
<span></span>
<span><span class="va">data_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">pr_proj</span><span class="op">)</span>, <span class="va">meta_project</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">Tissue</span>, <span class="st">" Projected"</span><span class="op">)</span>, Data <span class="op">=</span> <span class="st">'Projection'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pr_run</span><span class="op">$</span><span class="va">x</span>, <span class="va">meta_ref</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Cohort</span> <span class="op">==</span> <span class="st">'Body'</span> <span class="op">~</span> <span class="st">'Body'</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">PC1</span>,y<span class="op">=</span><span class="va">PC2</span>, color <span class="op">=</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_mark_circle.html" class="external-link">geom_mark_circle</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Data</span> <span class="op">==</span> <span class="st">'Projection'</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">2</span>,<span class="st">"mm"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">alphabet</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">12</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_testing_files/figure-html/projectR_based_pca-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="metamorph">metamoRph<a class="anchor" aria-label="anchor" href="#metamorph"></a>
</h2>
<p>metamoRph’s two steps (<code>run_pca</code> and
<code>metamoRph</code>) gets the new data into the proper scale for the
projection to work properly.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_pca.html">run_pca</a></span><span class="op">(</span>feature_by_sample <span class="op">=</span> <span class="va">ref_matrix</span><span class="op">[</span><span class="va">select</span>,<span class="op">]</span>,</span>
<span>                      meta <span class="op">=</span> <span class="va">meta_ref</span>,</span>
<span>                      hvg_selection <span class="op">=</span> <span class="st">'classic'</span>,</span>
<span>                      sample_cpm_scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># project data from the pca</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">' \\(.*'</span>,<span class="st">''</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">projected_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span>,</span>
<span>                            <span class="va">pca_output</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>,</span>
<span>                            center_scale <span class="op">=</span> <span class="va">pca_output</span><span class="op">$</span><span class="va">center_scale</span>,</span>
<span>                            sample_cpm_scale <span class="op">=</span>  <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">data_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">projected_data</span>, <span class="va">meta_project</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">Tissue</span>, <span class="st">" Projected"</span><span class="op">)</span>,</span>
<span>                                      Data <span class="op">=</span> <span class="st">'Projection'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pca_output</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span>, <span class="va">meta_ref</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Data <span class="op">=</span> <span class="st">'Original'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Cohort</span> <span class="op">==</span> <span class="st">'Body'</span> <span class="op">~</span> <span class="st">'Body'</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">PC1</span>,y<span class="op">=</span><span class="va">PC2</span>,color <span class="op">=</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">alphabet</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_mark_ellipse.html" class="external-link">geom_mark_ellipse</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Data</span> <span class="op">==</span> <span class="st">'Projection'</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_mark_ellipse.html" class="external-link">geom_mark_ellipse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_testing_files/figure-html/metamoRph_eiad_pca-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="metamorph-with-cpm-scaling-and-scran-hvg-selection">metamoRph with cpm scaling and scran HVG selection<a class="anchor" aria-label="anchor" href="#metamorph-with-cpm-scaling-and-scran-hvg-selection"></a>
</h2>
<p>The CPM and scran steps modestly improves the PC1/PC2 distinction
between the tissue types as well as pulling some outliers back towards
their matching tissue type.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_pca.html">run_pca</a></span><span class="op">(</span><span class="va">ref_matrix</span><span class="op">[</span><span class="va">select</span>,<span class="op">]</span>,</span>
<span>                      <span class="va">meta_ref</span>,</span>
<span>                      hvg_selection <span class="op">=</span> <span class="st">'scran'</span>,</span>
<span>                      sample_cpm_scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># project data from the pca</span></span>
<span><span class="va">projected_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metamoRph.html">metamoRph</a></span><span class="op">(</span><span class="va">new_mat_for_projection</span>,</span>
<span>                            <span class="va">pca_output</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">rotation</span>,</span>
<span>                            center_scale <span class="op">=</span> <span class="va">pca_output</span><span class="op">$</span><span class="va">center_scale</span>,</span>
<span>                            sample_cpm_scale <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">projected_data</span>, <span class="va">meta_project</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">Tissue</span>, <span class="st">" Projected"</span><span class="op">)</span>,</span>
<span>                                      Data <span class="op">=</span> <span class="st">'Projection'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pca_output</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span>, <span class="va">meta_ref</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Data <span class="op">=</span> <span class="st">'Original'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Tissue <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">Cohort</span> <span class="op">==</span> <span class="st">'Body'</span> <span class="op">~</span> <span class="st">'Body'</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">PC1</span>,y<span class="op">=</span><span class="va">PC2</span>,color <span class="op">=</span> <span class="va">Tissue</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu">pals</span><span class="fu">::</span><span class="fu"><a href="https://kwstat.github.io/pals/reference/discrete.html" class="external-link">alphabet</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_mark_ellipse.html" class="external-link">geom_mark_ellipse</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_plot</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Data</span> <span class="op">==</span> <span class="st">'Projection'</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">'red'</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggforce</span><span class="fu">::</span><span class="fu"><a href="https://ggforce.data-imaginist.com/reference/geom_mark_ellipse.html" class="external-link">geom_mark_ellipse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/theme_cowplot.html" class="external-link">theme_cowplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_testing_files/figure-html/metamoRph_eiad_pca_with_sample_scaling-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="label-transfer">Label Transfer<a class="anchor" aria-label="anchor" href="#label-transfer"></a>
</h2>
<p>Finally we demonstrate the two step process for transferring over the
labels from the input data onto the projected data.</p>
<p>First we run <code>model_build</code> on the original
<code>pca_output</code> eigenvalue matrix (<code>$x</code>). You also
have to provide the label data of interest to transfer
(<code>tissue</code>). Behind the scenes a <code>lm</code> model is
built for each unique label (in this case <code>tissue</code>) against
all of the other tissues using the first 10 PCs. The output is a list of
models (one for each tissue type).</p>
<p>We can then use this list of models in <code>model_apply</code> as
well as the projected data from <code>metamoRph</code>. We provide (this
is optional) the true labels of the projected data. A tibble is returned
which gives the original label (if provided) in the
<code>sample_label</code> field as well as the predicted label (the
<code>predict</code>) field. The <code>max_score</code> is the
confidence that the model has in the prediction. Closer to 0 is low
confidence while closer to 1 is high confidence.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trained_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_build.html">model_build</a></span><span class="op">(</span><span class="va">pca_output</span><span class="op">$</span><span class="va">PCA</span><span class="op">$</span><span class="va">x</span>,</span>
<span>                             <span class="va">pca_output</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">Tissue</span>,</span>
<span>                             model <span class="op">=</span> <span class="st">'lm'</span>, num_PCs <span class="op">=</span> <span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             BPPARAM <span class="op">=</span> <span class="fu">MulticoreParam</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">label_guesses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_apply.html">model_apply</a></span><span class="op">(</span><span class="va">trained_model</span>,</span>
<span>                             <span class="va">projected_data</span>,</span>
<span>                             <span class="va">meta_project</span><span class="op">$</span><span class="va">Tissue</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">label_guesses</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 6</span></span></span>
<span><span class="co">#&gt;    sample_id  sample_label predict predict_second    predict_stringent max_score</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SRS8476047 Retina       Retina  Conjunctiva       Retina                0.980</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SRS8476048 Retina       Retina  Conjunctiva       Retina                1.06 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SRS8476049 Retina       Retina  Conjunctiva       Retina                1.05 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SRS8476039 Retina       Retina  Conjunctiva       Retina                1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SRS8476038 Retina       Retina  Trabecular Meshw… Retina                1.03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SRS8476040 Retina       Retina  Trabecular Meshw… Retina                1.00 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SRS8476041 Retina       Retina  Trabecular Meshw… Retina                1.03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SRS8476042 Retina       Retina  Conjunctiva       Retina                0.986</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SRS8476043 Retina       Retina  Trabecular Meshw… Retina                1.03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SRS8476044 Retina       Retina  Trabecular Meshw… Retina                0.979</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> SRS8476045 Retina       Retina  Trabecular Meshw… Retina                1.03 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> SRS8476046 Retina       Retina  Conjunctiva       Retina                1.06</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by David McGaughey.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
